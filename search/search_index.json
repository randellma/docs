{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Welcome to Matt Randell Docs","text":"<p>For maintaining docs and decisions of ongoing side projects.</p>"},{"location":"Wayfair%20Discount/ADR001%20-%20Local%20Web%20App/","title":"ADR001 Local Web App MVP","text":"<p>The goal for this project is to automate receiving discount requests from friends/family, checking it for them, and returning the relevant results with as little interruption to me as possible.</p>"},{"location":"Wayfair%20Discount/ADR001%20-%20Local%20Web%20App/#status","title":"Status","text":"<p>Complete</p>"},{"location":"Wayfair%20Discount/ADR001%20-%20Local%20Web%20App/#context","title":"Context","text":"<p>Providing Wayfair discounts to friends and family is allowed and encouraged, but the discount is not a fixed amount and varies by wholesale cost, and therefore varies by product, shipping location, and time that it is checked. To perform a discount check for someone you need to either find the wholesale cost and apply the calculation, or manually add the product to your cart, and apply the employee discount check. Therefore, it's tedious to check discounts for people in a timely manner and without them feeling like they are bothering me. </p>"},{"location":"Wayfair%20Discount/ADR001%20-%20Local%20Web%20App/#limitations","title":"Limitations","text":"<ul> <li>Getting wholesale price requires VPN access so it cannot be done in a hands-off automated way.</li> <li>Password sharing is not an option.</li> <li>I have friends in both US and Canada so will have to support wayfair.com and wayfair.ca</li> <li>Getting discount info requires the product to be in your Wayfair cart and manually applying the employee discount to the cart.</li> </ul>"},{"location":"Wayfair%20Discount/ADR001%20-%20Local%20Web%20App/#decision","title":"Decision","text":"<p>Create a Next.js web application that will host a very basic input form for users to provide their zip/postal code and a link to a wayfair (.com or .ca) product page. Submitting the form will send the request to the backend server to be queued up, discount checked, and results saved for future reference for the user.</p> <p>To do the actual discount fetching, a Puppeteer NodeJS script will be used </p> <p>MVP Architecture</p>"},{"location":"Wayfair%20Discount/ADR001%20-%20Local%20Web%20App/#consequences","title":"Consequences","text":"<ul> <li>The script can only be run one at a time, so a semaphore has to be used to restrict multiple requests from being executed simultanesously.</li> <li>The api waits for the puppeteer script to finish, so it can result in a long user wait (especially if simultaneous requests are being processed).</li> <li>Home server solution is scrappy, but would be better to host it in a free hosting environment like Vercel.</li> <li>The puppeteer solution cannot be used off-prem due to security and botting detection reasons.</li> <li>It's clunky to have to open the web app, paste a link, and have to wait for the results.</li> </ul>"},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/","title":"ADR002 Message Broker","text":"<p>Mainly an excuse to play around with Golang, but also, finally migrate the Next.js web app to be freely hosted in Vercel by properly queuing, and asynchronously performing discount checker requests thereby unlocking some asynchronous discount check delivery methods to explore (SMS, whatsApp, email, etc).</p>"},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/#status","title":"Status","text":"<p>Complete</p>"},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/#context","title":"Context","text":"<p>Presently, discount.mattrandell.com is a NextJ.js web application running on an old Macbook Air in my basement that uses a Puppeteer browser automation script to perform the web scraping to fetch discount information on a friend/family\u2019s behalf. </p> <p>Some drawbacks of this approach:</p> <ul> <li>No static IP at home so I\u2019ve needed to fix that on occasion.</li> <li>There are inherent security risks of having a web server on my home network.</li> <li>It is not TLS encrypted. (mainly out of laziness and intention to migrate to Vercel where it comes for free)</li> <li>The macbook air is slow for hosting a Next.js app.</li> <li>Currently manually deploying when there are changes.</li> <li>Multiple simultaneous discount requests are still synchronous, the request waits for the script to be free.</li> <li>Discount data is locally stored on this Macbook so if it dies then so does everyone\u2019s history.</li> </ul> <p>Note: The puppeteer script cannot easily be moved out of the basement without security risk, and increased likelihood of bot detection circumventing the entire strategy.</p>"},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/#decision","title":"Decision","text":"<p>The lookup process should be managed by a message broker. Discount requests should be placed on a queue/topic and complete immediately if enqueuing is successful. An asynchronous service (written in Go just because I want to) will then ingest the requests, perform the web scraping lookup, and reply with the result to be delivered to the user.</p>"},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/#architecture","title":"Architecture","text":""},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/#database-schema","title":"Database Schema","text":"<p>user</p> <ul> <li>id: int</li> <li>email: text</li> <li>...columns for Auth.js</li> </ul> <p>discount_result</p> <ul> <li>id: int</li> <li>email: text</li> <li>txId: text</li> <li>data: text</li> <li>created_at: datetime</li> <li>updated_at: datetime</li> </ul>"},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/#to-do","title":"To do","text":"<ul> <li>Find a free-tiered message broker solution. (Vercel? Firebase? GCP?)</li> <li>Create a Go service to:<ul> <li>Await for discount requests</li> <li>Trigger the puppeteer script</li> <li>Send the results via message queue</li> </ul> </li> <li>Determine how the Next.js app will receive the results and deliver them to the user.<ul> <li>Maybe polling to start?</li> <li>Web socket?</li> </ul> </li> <li>Migrate web app to vercel.</li> <li>Migrate file storage to postgres storage.</li> </ul>"},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/#consequences","title":"Consequences","text":""},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/#benefits","title":"Benefits","text":"<ul> <li>Web app is TLS authenticated, and automatically deployed to Vercel when there are changes.</li> <li>Eliminates non-static IP difficulties - ingress traffic no longer needs to be allowed since it will be reaching out to the message broker instead.</li> </ul>"},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/#drawbacks","title":"Drawbacks","text":"<ul> <li>Increase complexity with message broker  and additional service needed.</li> <li>New language in the tech stack (but that\u2019s kinda the point).</li> <li>The Go service and Puppeteer script still needs to be hosted in the basement.</li> </ul>"},{"location":"Wayfair%20Discount/ADR002%20-%20Message%20Broker/#post-implementation-notes","title":"Post Implementation Notes","text":"<ul> <li>Implemented and then abandoned the Go service as it was just adding complexity in calling the puppeteer script. Using a Node script to subscribe to pubsub and it can just call the script normally.</li> <li>Landed on using GCP pubsub for a message broker<ul> <li>Topics:<ul> <li>discount-request</li> <li>discount-request-dlq</li> <li>discount-result</li> <li>discount-result-dlq</li> </ul> </li> <li>Subscriptions:<ul> <li>discount-request-sub-local - for local testing, uses env: local attribute as a filter</li> <li>discount-request-sub-prod - for prod, uses env: prod attribute as a filter</li> <li>discount-result-sub - consumes local and prod results, uses a push sub to the vercel hosted app.</li> </ul> </li> </ul> </li> <li>The move to Vercel hosting moved things to https, so locatstorage for users is lost. Not going to bother with a migration path.</li> <li>Delivering the results to users is done by polling from the browser - the txId is returned immediately for the web app once submitted to the request topic, then the web app polls the server until the result is available.<ul> <li>Not ideal, but good for now and gets around the Vercel function time limit.</li> </ul> </li> <li>Fully migrated web-ui and discount.* domain to Vercel and no longer have web server running locally and no need for ingress port.</li> <li>Enabled authentication as I was worried that hosting at the Vercel IP would be more likely to attract anonymous traffic.</li> <li>Have not associated discount requests to users yet.</li> <li>Excluded auth for <code>/view</code> and <code>/api/discoutResult</code> routes. <ul> <li><code>/view</code> is needed for viewing discount results anonymously</li> <li><code>/api/discountResult</code> needed for pubsub push subscriptions but looking into enabling auth to validate the request comes from google.</li> </ul> </li> </ul>"},{"location":"Wayfair%20Discount/ADR003%20-%20Replace%20Puppeteer/","title":"ADR003 Replace Puppeteer","text":""},{"location":"Wayfair%20Discount/ADR003%20-%20Replace%20Puppeteer/#status","title":"Status","text":"<p>Complete</p>"},{"location":"Wayfair%20Discount/ADR003%20-%20Replace%20Puppeteer/#context","title":"Context","text":""},{"location":"Wayfair%20Discount/ADR003%20-%20Replace%20Puppeteer/#decision","title":"Decision","text":""},{"location":"Wayfair%20Discount/ADR003%20-%20Replace%20Puppeteer/#architecture","title":"Architecture","text":""},{"location":"Wayfair%20Discount/ADR003%20-%20Replace%20Puppeteer/#to-do","title":"To do","text":""},{"location":"Wayfair%20Discount/ADR003%20-%20Replace%20Puppeteer/#consequences","title":"Consequences","text":""},{"location":"Wayfair%20Discount/ADR003%20-%20Replace%20Puppeteer/#benefits","title":"Benefits","text":""},{"location":"Wayfair%20Discount/ADR003%20-%20Replace%20Puppeteer/#drawbacks","title":"Drawbacks","text":""},{"location":"Wayfair%20Discount/ADR003%20-%20Replace%20Puppeteer/#post-implementation-notes","title":"Post Implementation Notes","text":""}]}